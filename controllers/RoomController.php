<?php
namespace HotelFactory\controllers;

use HotelFactory\forms\EditRoomsForm;
use HotelFactory\managers\HotelManager;
use HotelFactory\core\Controller;
use HotelFactory\forms\AddRoomForm;
use HotelFactory\managers\RoomManager;
use HotelFactory\models\Room;
use HotelFactory\core\View;
use HotelFactory\core\Helper;

class RoomController extends Controller
{


    /* Afficher les Roomaires */
    public function listAction(){
        $roomManager = new RoomManager();
        $rooms = $roomManager->findBy(array("idHotel"=>$_SESSION['hotel']));
        $configTableRooms = Room::showRoomTable($rooms);
        $myView = new View("{$_SESSION['dir']}/room/list", "back");
        $myView->assign("configTableRooms", $configTableRooms);
    }

    public function formRoomAction(){
        $hotelManager = new HotelManager();
        $hotels = $hotelManager->findBy(array("idUser"=>$_SESSION['id']));
        $configFormRooms = AddRoomForm::getForm();
        $myView = new View("{$_SESSION['dir']}/room/create", "back");
        array_push($configFormRooms, array("idHotel"=>$hotels[0]->getId()));
        $myView->assign("configFormRooms", $configFormRooms);
        //$myView->assign("id",$hotels[0]->getId());
    }


    public function createAction()
    {
        if(isset($_POST) && !(empty($_POST)))
        {

            if(isset($_POST['idHotel'])):
                $_POST['idHotel'] = $_SESSION['hotel'];
            endif;
            $qte = $_POST["quantity"];
            $i=0;
            while ( $i<$qte ) {
                $room = new Room();
                $room = $room->hydrate($_POST);
                $roomManager = new RoomManager();
                $roomManager->save($room);
                $i=$i+1;
            }
        }
        header("Location: /settings/room/list");
    }

    /* Mettre à jour une chambre */
    public function updateAction()
    {

        $roomManager = new RoomManager();
        $room = $roomManager->find($_POST['id']);
        $room = $room->hydrate($_POST);
        $roomManager->save($room);
        header("Location: /dashboard/rooms");
    }


    public function editFormAction(){
        //je verifie l'idHotel de la room où l'id = $_GET["id()] . Si idHotel == $_SESSION["hotel"] alors j'affiche sinon nn
        //find->idRoom= $_get["id"]/ $room["idHotel"] == $_SESSION[id]
        //Ne pas avoir accès à la page si l'id n'existe pas 
        if(!(is_numeric($_GET['id']))){
            header("Location: /settings/room/list");
        }
        $roomManager = new RoomManager();
        $rooms = $roomManager->findBy(array("idHotel"=>$_SESSION['hotel']));
        $count = $roomManager->count(array("id"=>$_GET['id']));
        
        if($count > 0){
            $room = $roomManager->find($_GET['id']);
            if($room->getIdHotel() != $_SESSION['hotel'] || empty($_GET['id'])){
                header("Location: /settings/room/list");
            }
        }else{
            header("Location: /settings/room/list");
        }

        $configFormRooms = EditRoomsForm::getForm();
        $myView = new View("{$_SESSION['dir']}/room/edit", "back");
        $myView->assign("configFormRoom", $configFormRooms);
    }




















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    /* Mettre à jour un Service */
    public function editAction()
    {
        $roomManager = new RoomManager();
        $room = $roomManager->find($_POST['id']);
        $room = $room->hydrate($_POST);
        $roomManager->save($room);
        header("Location: /settings/room/list");
    }


    public function deleteAction()
    {
        $roomManager = new RoomManager();
        $roomManager->delete($_GET['id']);
        header("Location: /settings/room/list");
    }


    
    public function statusAction()
    {
        if(isset($_GET) && !(empty($_GET)))
        {
        $roomManager = new RoomManager();
        $room = $roomManager->find($_GET['id']);
            echo $_GET['status'];
        
        if($_GET["status"]==0){
            $room->setStatus(1);
        }else{
            $room->setStatus(0);
            print_r($page);
            echo "h";
        }
        $roomManager->save($room);
        }
        $this->redirectTo('Room','list'); 
    }


}